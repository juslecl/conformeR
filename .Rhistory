) +
theme(legend.position = "bottom", legend.title = element_blank(), strip.text = element_text(face = "bold"))
p_hist_all <- ggplot(res_binned_all, aes(x = bin_mid, y = count, fill = mean_dev)) +
geom_col(width = 1 / 30, color = "white", alpha = 0.9) +
scale_fill_viridis_c(option = "plasma", name = "Mean dev") +
scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "p-values",
y = "Count",
title = "p-value histogram (colored by per-bin mean dev to mu_0)"
) +
theme(legend.position = "bottom", legend.title = element_blank(), strip.text = element_text(face = "bold"))
# --- FDR curve --- # This part has to be refined.
pvals <- res$PVAL$pvalue
cutoffs <- seq(0, 1, by = 0.01)
if (delta==0){
fdr_data <- data.frame(cutoff = cutoffs) %>%
rowwise() %>%
mutate(fdr = (sum(pvals<cutoff)/length(pvals))) %>%
ungroup()
p_fdr <- ggplot(fdr_data, aes(x = cutoff, y = fdr)) +
geom_line(color = "blue", size = 1.2) +
geom_hline(yintercept = 0.05, linetype = "dashed", color = "darkgreen", size = 1) +
geom_hline(yintercept = 0.1, linetype = "dashed", color = "lightgreen", size = 1) +
scale_x_continuous(breaks = seq(0, 1, 0.1)) +
scale_y_continuous(limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "P-value cutoff",
y = "FDR",
title = "FDR as a function of P-value cutoff"
)
} else {
fdr_data <- data.frame(cutoff = cutoffs) %>%
rowwise() %>%
mutate(power = (sum(pvals<cutoff)/length(pvals))) %>%
ungroup()
p_fdr <- ggplot(fdr_data, aes(x = cutoff, y = power)) +
geom_line(color = "blue", size = 1.2) +
geom_hline(yintercept = 0.05, linetype = "dashed", color = "darkgreen", size = 1) +
geom_hline(yintercept = 0.1, linetype = "dashed", color = "lightgreen", size = 1) +
scale_x_continuous(breaks = seq(0, 1, 0.1)) +
scale_y_continuous(limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "P-value cutoff",
y = "Power",
title = "Power as a function of P-value cutoff"
)
}
return(list(
sce = sce,
res = res,
hist_plot = p_hist,
hist_all = p_hist_all,
fdr_plot = p_fdr,
pval_summary = c(mean(pvals),sd(pvals))
))
}
run_conformeR_sim()
run_conformeR_sim <- function(
n = 500,
d = 100,
rho = c(.9,.3,.8,.2),
delta = .5,
rangevar = c(0, 1),
gene_target = "gene100",
spacing = 0.01,
size_train = 0.5,
size_cal = 0.25
) {
p <- d-1
# --- Create covmatT0 ---
covmatT0 <- clusterGeneration::genPositiveDefMat(
p, covMethod = "unifcorrmat", rangeVar = rangevar
)$Sigma
# --- Create covmatT1 ---
covmatT1 <- clusterGeneration::genPositiveDefMat(
p, covMethod = "unifcorrmat", rangeVar = rangevar
)$Sigma
# --- Draw means ---
muT0 <- sample(seq(.5, 3, .25), p, replace = TRUE)
muT1 <- sample(seq(1.5, 4, .25), p, replace = TRUE)
# --- Simulate all but the gene of interest ---
sceT0 <- t(MASS::mvrnorm(n = n, mu = muT0, Sigma = covmatT0))
sceT1 <- t(MASS::mvrnorm(n = n, mu = muT1, Sigma = covmatT1))
# --- Simulate the gene of interest ---
means0 <- apply(sceT0,2,mean)
means1 <- apply(sceT1,2,mean)
unif0 <- cbind(means0,means0+log(10))
unif1 <- cbind(means1,means1+log(10))
sceT0 <- rbind(sceT0,apply(unif0,1,function(row) runif(1,min=row[1],max=row[2])))
sceT1 <- rbind(sceT1,apply(unif1,1,function(row) runif(1,min=row[1],max=row[2])))
sce <- SingleCellExperiment::SingleCellExperiment(list(logcounts = cbind(sceT0, sceT1)))
rownames(sce) <- paste0("gene",1:100)
#sce <- scuttle::logNormCounts(sce)
sce$group <- rep(c(0, 1), each = n)
sce$batch <- rep("Nicolò", 2 * n)
sce$cell <- rep("pbc", 2 * n)
#logFCtrue <- log(muT1[d]/muT0[d], base=2)
# --- Conformal inference on one gene ---
res <- conformeR_one_gene(
sce = sce,
obs_condition = "group",
replicate_id = "batch",
cell_type = "cell",
spacing = spacing,
size_train = size_train,
size_cal = size_cal
)
res$PVAL <- cbind(
res$PVAL,
group = res$TEST$group,
dev = abs(res$TEST[[gene_target]] - muT0[d])
)
# --- Histogram per group ---
breaks <- seq(0, 1, length.out = 31)
bin_labels <- levels(cut(breaks[-1], breaks = breaks, include.lowest = TRUE))
bin_mid <- (breaks[-length(breaks)] + breaks[-1]) / 2
lookup <- data.frame(bin = bin_labels, bin_mid = bin_mid)
res_binned <- res$PVAL %>%
group_by(group) %>%
mutate(bin = cut(pvalue, breaks = breaks, include.lowest = TRUE)) %>%
group_by(group, bin) %>%
summarise(
count = n(),
mean_dev = mean(dev, na.rm = TRUE),
.groups = "drop"
) %>%
left_join(lookup, by = "bin")
res_binned_all <- res$PVAL %>%
mutate(bin = cut(pvalue, breaks = breaks, include.lowest = TRUE)) %>%
group_by(bin) %>%
summarise(
count = n(),
mean_dev = mean(dev, na.rm = TRUE),
.groups = "drop"
) %>%
left_join(lookup, by = "bin")
p_hist <- ggplot(res_binned, aes(x = bin_mid, y = count, fill = mean_dev)) +
geom_col(width = 1 / 30, color = "white", alpha = 0.9) +
facet_wrap(~ group, scales = "free_y") +
scale_fill_viridis_c(option = "plasma", name = "Mean dev") +
scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "p-values",
y = "Count",
title = "p-value histograms (colored by per-bin mean dev to mu_0)"
) +
theme(legend.position = "bottom", legend.title = element_blank(), strip.text = element_text(face = "bold"))
p_hist_all <- ggplot(res_binned_all, aes(x = bin_mid, y = count, fill = mean_dev)) +
geom_col(width = 1 / 30, color = "white", alpha = 0.9) +
scale_fill_viridis_c(option = "plasma", name = "Mean dev") +
scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "p-values",
y = "Count",
title = "p-value histogram (colored by per-bin mean dev to mu_0)"
) +
theme(legend.position = "bottom", legend.title = element_blank(), strip.text = element_text(face = "bold"))
# --- FDR curve --- # This part has to be refined.
pvals <- res$PVAL$pvalue
cutoffs <- seq(0, 1, by = 0.01)
if (delta==0){
fdr_data <- data.frame(cutoff = cutoffs) %>%
rowwise() %>%
mutate(fdr = (sum(pvals<cutoff)/length(pvals))) %>%
ungroup()
p_fdr <- ggplot(fdr_data, aes(x = cutoff, y = fdr)) +
geom_line(color = "blue", size = 1.2) +
geom_hline(yintercept = 0.05, linetype = "dashed", color = "darkgreen", size = 1) +
geom_hline(yintercept = 0.1, linetype = "dashed", color = "lightgreen", size = 1) +
scale_x_continuous(breaks = seq(0, 1, 0.1)) +
scale_y_continuous(limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "P-value cutoff",
y = "FDR",
title = "FDR as a function of P-value cutoff"
)
} else {
fdr_data <- data.frame(cutoff = cutoffs) %>%
rowwise() %>%
mutate(power = (sum(pvals<cutoff)/length(pvals))) %>%
ungroup()
p_fdr <- ggplot(fdr_data, aes(x = cutoff, y = power)) +
geom_line(color = "blue", size = 1.2) +
geom_hline(yintercept = 0.05, linetype = "dashed", color = "darkgreen", size = 1) +
geom_hline(yintercept = 0.1, linetype = "dashed", color = "lightgreen", size = 1) +
scale_x_continuous(breaks = seq(0, 1, 0.1)) +
scale_y_continuous(limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "P-value cutoff",
y = "Power",
title = "Power as a function of P-value cutoff"
)
}
return(list(
sce = sce,
res = res,
hist_plot = p_hist,
hist_all = p_hist_all,
fdr_plot = p_fdr,
pval_summary = c(mean(pvals),sd(pvals))
))
}
run_conformeR_sim()
t.test(yi0,yi1)
run_conformeR_sim <- function(
n = 500,
d = 100,
rho = c(.9,.3,.8,.2),
delta = .5,
rangevar = c(0, 0.5),
gene_target = "gene100",
spacing = 0.01,
size_train = 0.5,
size_cal = 0.25
) {
p <- d-1
# --- Create covmatT0 ---
covmatT0 <- clusterGeneration::genPositiveDefMat(
p, covMethod = "unifcorrmat", rangeVar = rangevar
)$Sigma
# --- Create covmatT1 ---
covmatT1 <- clusterGeneration::genPositiveDefMat(
p, covMethod = "unifcorrmat", rangeVar = rangevar
)$Sigma
# --- Draw means ---
muT0 <- sample(seq(.5, 3, .25), p, replace = TRUE)
muT1 <- sample(seq(1.5, 4, .25), p, replace = TRUE)
# --- Simulate all but the gene of interest ---
sceT0 <- t(MASS::mvrnorm(n = n, mu = muT0, Sigma = covmatT0))
sceT1 <- t(MASS::mvrnorm(n = n, mu = muT1, Sigma = covmatT1))
# --- Simulate the gene of interest ---
means0 <- apply(sceT0,2,mean)
means1 <- apply(sceT1,2,mean)
unif0 <- cbind(means0,means0+log(10))
unif1 <- cbind(means1,means1+log(10))
sceT0 <- rbind(sceT0,apply(unif0,1,function(row) runif(1,min=row[1],max=row[2])))
sceT1 <- rbind(sceT1,apply(unif1,1,function(row) runif(1,min=row[1],max=row[2])))
sce <- SingleCellExperiment::SingleCellExperiment(list(logcounts = cbind(sceT0, sceT1)))
rownames(sce) <- paste0("gene",1:100)
#sce <- scuttle::logNormCounts(sce)
sce$group <- rep(c(0, 1), each = n)
sce$batch <- rep("Nicolò", 2 * n)
sce$cell <- rep("pbc", 2 * n)
#logFCtrue <- log(muT1[d]/muT0[d], base=2)
# --- Conformal inference on one gene ---
res <- conformeR_one_gene(
sce = sce,
obs_condition = "group",
replicate_id = "batch",
cell_type = "cell",
spacing = spacing,
size_train = size_train,
size_cal = size_cal
)
res$PVAL <- cbind(
res$PVAL,
group = res$TEST$group,
dev = abs(res$TEST[[gene_target]] - muT0[d])
)
# --- Histogram per group ---
breaks <- seq(0, 1, length.out = 31)
bin_labels <- levels(cut(breaks[-1], breaks = breaks, include.lowest = TRUE))
bin_mid <- (breaks[-length(breaks)] + breaks[-1]) / 2
lookup <- data.frame(bin = bin_labels, bin_mid = bin_mid)
res_binned <- res$PVAL %>%
group_by(group) %>%
mutate(bin = cut(pvalue, breaks = breaks, include.lowest = TRUE)) %>%
group_by(group, bin) %>%
summarise(
count = n(),
mean_dev = mean(dev, na.rm = TRUE),
.groups = "drop"
) %>%
left_join(lookup, by = "bin")
res_binned_all <- res$PVAL %>%
mutate(bin = cut(pvalue, breaks = breaks, include.lowest = TRUE)) %>%
group_by(bin) %>%
summarise(
count = n(),
mean_dev = mean(dev, na.rm = TRUE),
.groups = "drop"
) %>%
left_join(lookup, by = "bin")
p_hist <- ggplot(res_binned, aes(x = bin_mid, y = count, fill = mean_dev)) +
geom_col(width = 1 / 30, color = "white", alpha = 0.9) +
facet_wrap(~ group, scales = "free_y") +
scale_fill_viridis_c(option = "plasma", name = "Mean dev") +
scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "p-values",
y = "Count",
title = "p-value histograms (colored by per-bin mean dev to mu_0)"
) +
theme(legend.position = "bottom", legend.title = element_blank(), strip.text = element_text(face = "bold"))
p_hist_all <- ggplot(res_binned_all, aes(x = bin_mid, y = count, fill = mean_dev)) +
geom_col(width = 1 / 30, color = "white", alpha = 0.9) +
scale_fill_viridis_c(option = "plasma", name = "Mean dev") +
scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "p-values",
y = "Count",
title = "p-value histogram (colored by per-bin mean dev to mu_0)"
) +
theme(legend.position = "bottom", legend.title = element_blank(), strip.text = element_text(face = "bold"))
# --- FDR curve --- # This part has to be refined.
pvals <- res$PVAL$pvalue
cutoffs <- seq(0, 1, by = 0.01)
if (delta==0){
fdr_data <- data.frame(cutoff = cutoffs) %>%
rowwise() %>%
mutate(fdr = (sum(pvals<cutoff)/length(pvals))) %>%
ungroup()
p_fdr <- ggplot(fdr_data, aes(x = cutoff, y = fdr)) +
geom_line(color = "blue", size = 1.2) +
geom_hline(yintercept = 0.05, linetype = "dashed", color = "darkgreen", size = 1) +
geom_hline(yintercept = 0.1, linetype = "dashed", color = "lightgreen", size = 1) +
scale_x_continuous(breaks = seq(0, 1, 0.1)) +
scale_y_continuous(limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "P-value cutoff",
y = "FDR",
title = "FDR as a function of P-value cutoff"
)
} else {
fdr_data <- data.frame(cutoff = cutoffs) %>%
rowwise() %>%
mutate(power = (sum(pvals<cutoff)/length(pvals))) %>%
ungroup()
p_fdr <- ggplot(fdr_data, aes(x = cutoff, y = power)) +
geom_line(color = "blue", size = 1.2) +
geom_hline(yintercept = 0.05, linetype = "dashed", color = "darkgreen", size = 1) +
geom_hline(yintercept = 0.1, linetype = "dashed", color = "lightgreen", size = 1) +
scale_x_continuous(breaks = seq(0, 1, 0.1)) +
scale_y_continuous(limits = c(0, 1)) +
theme_minimal(base_size = 14) +
labs(
x = "P-value cutoff",
y = "Power",
title = "Power as a function of P-value cutoff"
)
}
return(list(
sce = sce,
res = res,
hist_plot = p_hist,
hist_all = p_hist_all,
fdr_plot = p_fdr,
pval_summary = c(mean(pvals),sd(pvals))
))
}
run_conformeR_sim()
res <- run_conformeR_sim()
res[[2]]$TEST |> group_by(group) |> summarize(m=mean(gene100),sd=sd(gene100))
ggplot(res[[2]]$INT, aes(x = group)) +
geom_linerange(aes(ymin = min, ymax = max),
color = "steelblue", linewidth = 1.2) +
facet_wrap(~ group +
labs(
title = "Confidence Intervals by Group and Column Group",
x = "Group",
y = "Interval"
) +
theme_minimal(base_size = 14)
)
ggplot(res[[2]]$INT, aes(x = group)) +
geom_linerange(aes(ymin = min, ymax = max),
color = "steelblue", linewidth = 1.2) +
facet_wrap(~ group) +
labs(
title = "Confidence Intervals by Group and Column Group",
x = "Group",
y = "Interval"
) +
theme_minimal(base_size = 14)
p <- d-1
# --- Create covmatT0 ---
covmatT0 <- clusterGeneration::genPositiveDefMat(
p, covMethod = "unifcorrmat", rangeVar = rangevar
)$Sigma
# --- Create covmatT1 ---
covmatT1 <- clusterGeneration::genPositiveDefMat(
p, covMethod = "unifcorrmat", rangeVar = rangevar
)$Sigma
# --- Draw means ---
muT0 <- sample(seq(.5, 3, .25), p, replace = TRUE)
muT1 <- sample(seq(1.5, 4, .25), p, replace = TRUE)
# --- Simulate all but the gene of interest ---
sceT0 <- t(MASS::mvrnorm(n = n, mu = muT0, Sigma = covmatT0))
sceT1 <- t(MASS::mvrnorm(n = n, mu = muT1, Sigma = covmatT1))
# --- Simulate the gene of interest ---
means0 <- apply(sceT0,2,mean)
means1 <- apply(sceT1,2,mean)
unif0 <- cbind(means0,means0+log(10))
unif1 <- cbind(means1,means1+log(10))
sceT0 <- rbind(sceT0,apply(unif0,1,function(row) runif(1,min=row[1],max=row[2])))
sceT1 <- rbind(sceT1,apply(unif1,1,function(row) runif(1,min=row[1],max=row[2])))
sce <- SingleCellExperiment::SingleCellExperiment(list(logcounts = cbind(sceT0, sceT1)))
rownames(sce) <- paste0("gene",1:100)
#sce <- scuttle::logNormCounts(sce)
sce$group <- rep(c(0, 1), each = n)
sce$batch <- rep("Nicolò", 2 * n)
sce$cell <- rep("pbc", 2 * n)
p <- d-1
# --- Create covmatT0 ---
covmatT0 <- clusterGeneration::genPositiveDefMat(
p, covMethod = "unifcorrmat", rangeVar = rangevar
)$Sigma
# --- Create covmatT1 ---
covmatT1 <- clusterGeneration::genPositiveDefMat(
p, covMethod = "unifcorrmat", rangeVar = rangevar
)$Sigma
# --- Draw means ---
muT0 <- sample(seq(.5, 3, .25), p, replace = TRUE)
muT1 <- sample(seq(1.5, 4, .25), p, replace = TRUE)
# --- Simulate all but the gene of interest ---
sceT0 <- t(MASS::mvrnorm(n = n, mu = muT0, Sigma = covmatT0))
sceT1 <- t(MASS::mvrnorm(n = n, mu = muT1, Sigma = covmatT1))
# --- Simulate the gene of interest ---
means0 <- apply(sceT0,2,mean)
means1 <- apply(sceT1,2,mean)
unif0 <- cbind(means0,means0+log(10))
unif1 <- cbind(means1,means1+log(10))
sceT0 <- rbind(sceT0,apply(unif0,1,function(row) runif(1,min=row[1],max=row[2])))
sceT1 <- rbind(sceT1,apply(unif1,1,function(row) runif(1,min=row[1],max=row[2])))
sce <- SingleCellExperiment::SingleCellExperiment(list(logcounts = cbind(sceT0, sceT1)))
rownames(sce) <- paste0("gene",1:100)
#sce <- scuttle::logNormCounts(sce)
sce$group <- rep(c(0, 1), each = n)
sce$batch <- rep("Nicolò", 2 * n)
sce$cell <- rep("pbc", 2 * n)
split <- data_processing(sce,
"batch",
"group",
"cell")
splits <- split
properT0 <- subset_by_condition(splits$train_set, obs_condition, 0)
obs_condition <- "group"
spacing <- .01
groups     <- levels(splits$train_set$conf_group)
alphas     <- seq(spacing, 1 - spacing, spacing)
gene_names <- rownames(sce)
stopifnot(ncol(properT0) > 2, ncol(properT1) > 2)
properT0 <- subset_by_condition(splits$train_set, obs_condition, 0)
properT1 <- subset_by_condition(splits$train_set, obs_condition, 1)
calT0    <- subset_by_condition(splits$cal_set, obs_condition, 0)
calT1    <- subset_by_condition(splits$cal_set, obs_condition, 1)
test     <- splits$test_set
groups     <- levels(splits$train_set$conf_group)
alphas     <- seq(spacing, 1 - spacing, spacing)
gene_names <- rownames(sce)
stopifnot(ncol(properT0) > 2, ncol(properT1) > 2)
idx0 <- which(test[[obs_condition]] == 0)
idx1 <- which(test[[obs_condition]] == 1)
# Train quantile regressions
qrT0 <- train_qr(properT0, paste0("gene",d), gene_names)
qrT1 <- train_qr(properT1, paste0("gene",d), gene_names)
ps_model <- prop_score(rbind(properT0, properT1), paste0("gene",d), gene_names, obs_condition)
ps_cal   <- predict(ps_model, rbind(calT0, calT1), type = "prob") |> pull(.pred_1)
ps_test <- predict(ps_model, test, type = "prob") |> pull(.pred_1)
ps_cal[1:nrow(calT0)]
summary(ps_cal[1:nrow(calT0)])
summary(ps_cal[(nrow(calT0) + 1):length(w_cal)])
summary(ps_cal[(nrow(calT0) + 1):length(calT0)])
ps_test <- predict(ps_model, test, type = "prob") |> pull(.pred_1)
ps_test <- ifelse(ps_test==1,min(max(ps_test),1),ps_test)
ps_test <- ifelse(ps_test==0,1/nrow(test),ps_test)
ps_test[test$group==0]
summary(ps_test[test$group==0])
summary(ps_test[test$group==1])
scoresT0 <- compute_cqr_scores(qrT0, calT0, paste0("gene",d), alphas)
scoresT1 <- compute_cqr_scores(qrT1, calT1, paste0("gene",d), alphas)
library(ExperimentHub)
sc <- ExperimentHub::ExperimentHub()
sce <- sc[["EH2259"]]
BiocManager::install("SingleCellExperiment")
library(SingleCellExperiment)
sce <- sc[["EH2259"]]
remove.packages("generics", lib="/usr/local/lib/R/site-library")
library(generics)
library(BiocParallel)
#| include: false
.libPaths(c("/home/jlecle/R/x86_64-pc-linux-gnu-library/4.5", .libPaths()))
library(ggplot2)
library(dplyr)
library(knitr)
library(ranger)
library(workflows)
library(dplyr)
library(rsample)
library(probably)
library(quantregForest) # required by probably
library(parsnip)
library(MASS)
library(edgeR)
library(BiocParallel)
library(MAST)
library(SingleCellExperiment)
library(scuttle)
pb <- sumCountsAcrossCells(sce, ids = sce$group_id)
library(SingleCellExperiment)
library(muscat)
